<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Model Installation Button Styles */
        .model-install-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .model-install-btn:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .model-install-btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        /* Style for the install button in the model info modal */
        .modal-install-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: var(--border-radius);
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-install-btn:hover {
            background-color: var(--accent-hover);
        }

        .modal-install-btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Model info table styles */
        .model-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .model-info-table th {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .model-info-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--bg-tertiary);
            vertical-align: middle;
        }

        .model-info-table tr:last-child td {
            border-bottom: none;
        }

        .model-info-table tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* Installation progress styles */
        .progress-container {
            margin-top: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            height: 8px;
            width: 100%;
        }
        
        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color) 0%, #ba68c8 100%);
            border-radius: 4px;
            transition: width 0.5s;
        }
        
        .model-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .model-installed {
            background-color: var(--success-color);
        }
        
        .model-not-installed {
            background-color: var(--error-color);
        }
        
        .model-installing {
            background-color: var(--accent-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
        
        .model-info-tooltip {
            display: inline-block;
            margin-left: 5px;
            color: var(--text-secondary);
            cursor: help;
        }
        
        .installation-info {
            margin-top: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .model-status-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Installation section in chat */
        .model-install-message {
            background-color: rgba(138, 43, 226, 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 12px 16px;
            margin: 12px auto;
            border-radius: var(--border-radius);
            max-width: 90%;
        }

        .model-install-message h4 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Installation action buttons */
        .install-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-install-action {
            flex: 1;
            padding: 8px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: var(--transition);
        }

        .btn-install-confirm {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-install-confirm:hover {
            background-color: var(--accent-hover);
        }

        .btn-install-cancel {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-install-cancel:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Network troubleshooting styles */
        .network-troubleshooting {
            margin-top: 15px;
            background-color: rgba(33, 150, 243, 0.1);
            border-radius: var(--border-radius);
            padding: 10px 15px;
        }

        .network-troubleshooting h4 {
            color: #2196f3;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .network-troubleshooting ul {
            margin: 5px 0;
            padding-left: 20px;
        }

        .network-troubleshooting li {
            margin-bottom: 3px;
            font-size: 0.85rem;
        }

        .dns-check-section {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
        }

        .dns-status {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 0.85rem;
        }

        .dns-success {
            color: var(--success-color);
        }

        .dns-error {
            color: var(--error-color);
        }

        /* Tabs for model info modal */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--bg-tertiary);
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .small-models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .small-model-card {
            background-color: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        .small-model-card h4 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .small-model-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            flex-grow: 1;
        }

        .small-model-card .size {
            font-size: 0.75rem;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="app-header">
            <div class="logo">
                <i class="fas fa-robot"></i>
                <h1>LLM Chat</h1>
            </div>
            <div class="model-selector">
                <select id="model-dropdown">
                    {% for model in models %}
                    <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>{{ model }}</option>
                    {% endfor %}
                </select>
                <button id="connect-btn" class="btn" onclick="handleConnectClick()">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <div class="model-info-tooltip" id="model-info-icon" title="Check model installation status">
                    <i class="fas fa-info-circle"></i>
                </div>
            </div>
        </header>
        
        <!-- Model Info Modal -->
        <div id="model-info-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModelInfoModal()">&times;</span>
                <h2><i class="fas fa-cube"></i> Model Information</h2>
                
                <div class="tab-container">
                    <div class="tab active" data-tab="installed-models">Installed Models</div>
                    <div class="tab" data-tab="small-models">Small Models</div>
                    <div class="tab" data-tab="network-status">Network Status</div>
                </div>
                
                <div class="tab-content active" id="installed-models-tab">
                    <div id="model-info-content">
                        <p><i class="fas fa-spinner fa-spin"></i> Loading model information...</p>
                    </div>
                </div>
                
                <div class="tab-content" id="small-models-tab">
                    <p>These smaller models are easier to download and require less resources:</p>
                    <div id="small-models-content">
                        <p><i class="fas fa-spinner fa-spin"></i> Loading small models...</p>
                    </div>
                </div>
                
                <div class="tab-content" id="network-status-tab">
                    <h3>DNS Connection Status</h3>
                    <p>Checking connectivity to model hosting services:</p>
                    <div id="dns-check-content">
                        <p><i class="fas fa-spinner fa-spin"></i> Testing network connections...</p>
                    </div>
                    
                    <div class="network-troubleshooting">
                        <h4><i class="fas fa-tools"></i> Troubleshooting</h4>
                        <p>If you're experiencing network issues, try these solutions:</p>
                        <ul>
                            <li>Use Google's DNS servers (8.8.8.8 and 8.8.4.4)</li>
                            <li>Check your firewall/VPN settings</li>
                            <li>Try downloading a smaller model</li>
                            <li>Use the command line: <code>ollama pull tinyllama</code></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Network Troubleshooting Modal -->
        <div id="network-troubleshooting-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="document.getElementById('network-troubleshooting-modal').remove()">&times;</span>
                <h2><i class="fas fa-network-wired"></i> Network Troubleshooting</h2>
                
                <div class="troubleshooting-content">
                    <p>There appears to be a network issue preventing model download:</p>
                    <pre style="background: #1e1e1e; padding: 10px; overflow: auto; font-size: 0.8rem; color: #f44336; margin: 10px 0; border-radius: 4px; max-height: 100px;">
Error: DNS resolution failed (no such host)</pre>
                    
                    <h3>Possible solutions:</h3>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 1: Fix DNS Settings</h4>
                        <p>Try updating your DNS settings to use Google's public DNS servers:</p>
                        <ul>
                            <li>Primary DNS: 8.8.8.8</li>
                            <li>Secondary DNS: 8.8.4.4</li>
                        </ul>
                        <p><a href="https://developers.google.com/speed/public-dns/docs/using" target="_blank" style="color: var(--accent-color);">How to change DNS settings</a></p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 2: Use Command Line</h4>
                        <p>Installing models through the command line sometimes works better:</p>
                        <pre style="background: #1e1e1e; padding: 10px; font-family: monospace; margin: 10px 0; border-radius: 4px;">ollama pull tinyllama</pre>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 3: Use a Local Model</h4>
                        <p>You can also try using a smaller model that's easier to download:</p>
                        <div id="small-models-options">
                            <p><i class="fas fa-spinner fa-spin"></i> Loading small model options...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 4: Check Firewall Settings</h4>
                        <p>Make sure your firewall allows Ollama to connect to the internet.</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" style="background-color: var(--bg-tertiary); color: var(--text-primary);" onclick="document.getElementById('network-troubleshooting-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Divider Line -->
        <div class="divider"></div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Thread History Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-history"></i> Threads</h2>
                    <button id="new-thread-btn" class="btn-small" onclick="createNewThread()">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
                <div class="thread-list" id="thread-list">
                    <!-- Threads will be loaded here -->
                    <div class="thread-item active" data-id="new">
                        <i class="fas fa-comment-alt"></i>
                        <span>Untitled</span>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div class="chat-container">
                <div class="chat-header">
                    <!-- Thread title with rename button (centered) -->
                    <h2 id="current-thread-title">
                        <i class="fas fa-comment-alt"></i>
                        <span class="thread-title-text" id="thread-title-text">Untitled</span>
                        <button class="rename-btn" id="rename-thread-btn" title="Rename thread">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </h2>
                    
                    <!-- Chat actions (right-aligned) -->
                    <div class="chat-actions">
                        <button id="save-thread-btn" class="btn-small" onclick="handleSaveClick()">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button id="clear-chat-btn" class="btn-small" onclick="clearChat()">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Rename field that appears when renaming -->
                <div class="rename-field" id="rename-field" style="display: none;">
                    <input type="text" id="rename-input" placeholder="Enter thread name">
                    <button class="confirm-rename-btn" id="confirm-rename-btn" title="Confirm">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="cancel-rename-btn" id="cancel-rename-btn" title="Cancel">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="welcome-message">
                        <h3>Welcome to LLM Chat</h3>
                        <p>Currently using: <span id="current-model">{{ default_model }}</span></p>
                        <p>Start a conversation by typing a message below.</p>
                        <p class="model-note" style="font-size: 0.8rem; margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Models will be automatically installed if needed.
                        </p>
                    </div>
                    <!-- Messages will appear here dynamically -->
                </div>
                
                <div class="chat-input-container">
                    <textarea id="user-input" placeholder="Message your AI assistant..." rows="1"></textarea>
                    <button id="send-btn" class="btn" onclick="handleSendClick()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Thread Modal -->
    <div id="save-thread-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2><i class="fas fa-save"></i> Save Thread</h2>
            <input type="text" id="thread-name-input" placeholder="Enter a name for this thread">
            <button id="confirm-save-btn" class="btn" onclick="handleConfirmSaveClick()">
                Save Thread
            </button>
        </div>
    </div>
    
    <!-- Templates for dynamic content -->
    <template id="user-message-template">
        <div class="message user-message">
            <div class="message-content"></div>
        </div>
    </template>
    
    <template id="bot-message-template">
        <div class="message bot-message">
            <div class="message-content"></div>
        </div>
    </template>
    
    <template id="thread-item-template">
        <div class="thread-item">
            <i class="fas fa-comment-alt"></i>
            <span></span>
        </div>
    </template>
    
    <!-- JavaScript -->
    <script>
    // Simple global functions for button actions to ensure they're available
    function handleConnectClick() {
        console.log("Connect button clicked");
        if (typeof connectToModel === 'function') {
            connectToModel();
        }
    }
    
    function handleSendClick() {
        console.log("Send button clicked");
        if (typeof sendMessage === 'function') {
            sendMessage();
        }
    }

    function handleSaveClick() {
        console.log("Save button clicked");
        if (typeof openSaveModal === 'function') {
            openSaveModal();
        }
    }

    function handleConfirmSaveClick() {
        console.log("Confirm save button clicked");
        if (typeof saveThread === 'function') {
            saveThread();
        }
    }
    
    function closeModal() {
        const modal = document.getElementById('save-thread-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function closeModelInfoModal() {
        const modal = document.getElementById('model-info-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Model info functionality
    document.addEventListener('DOMContentLoaded', function() {
        const modelInfoIcon = document.getElementById('model-info-icon');
        const modelInfoModal = document.getElementById('model-info-modal');
        
        if (modelInfoIcon && modelInfoModal) {
            modelInfoIcon.addEventListener('click', async function() {
                // Show modal
                modelInfoModal.style.display = 'block';
                
                // Update content
                updateModelInfoContent();
                loadSmallModels();
                checkDnsStatus();
            });
        }
        
        // Set up tabs
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab content
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Show the corresponding tab content
                const tabId = this.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
    });
    
    async function updateModelInfoContent() {
        const contentDiv = document.getElementById('model-info-content');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading model information...</p>';
        
        try {
            // Fetch list of available models
            const response = await fetch('/api/check_all_models');
            
            if (!response.ok) {
                throw new Error('Failed to fetch model information');
            }
            
            const data = await response.json();
            
            // Create table of models
            let html = `
                <div class="model-info-description">
                    <p>The following models are available in this chat interface:</p>
                </div>
                <table class="model-info-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const model of data.models) {
                // Determine status class and text
                let statusClass = model.installed ? 'model-installed' : 'model-not-installed';
                let statusText = model.installed ? 'Installed' : 'Not Installed';
                
                // Create action button
                let actionButton = model.installed ? 
                    `<button class="modal-install-btn" disabled><i class="fas fa-check"></i> Installed</button>` : 
                    `<button class="modal-install-btn" onclick="installModelFromInfo('${model.name}')"><i class="fas fa-download"></i> Install</button>`;
                
                html += `
                    <tr>
                        <td>${model.name}</td>
                        <td>
                            <div class="model-status-container">
                                <span class="model-status ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </td>
                        <td>
                            ${actionButton}
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
                <div class="installation-info">
                    <p><i class="fas fa-info-circle"></i> Models are automatically installed when needed.</p>
                    <p>You can also install models manually using: <code>ollama pull model-name</code></p>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        } catch (error) {
            contentDiv.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> 
                    Error loading model information: ${error.message}
                </div>
                <p>Please make sure Ollama is running properly on your system.</p>
            `;
        }
    }
    
    async function loadSmallModels() {
        const smallModelsContent = document.getElementById('small-models-content');
        if (!smallModelsContent) return;
        
        smallModelsContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Loading small models...</p>';
        
        try {
            const response = await fetch('/api/list_small_models');
            
            if (!response.ok) {
                throw new Error('Failed to fetch small models');
            }
            
            const data = await response.json();
            
            if (data.models && data.models.length > 0) {
                let html = '<div class="small-models-grid">';
                
                for (const model of data.models) {
                    const isInstalled = model.installed;
                    const buttonHtml = isInstalled ?
                        `<button class="modal-install-btn" disabled><i class="fas fa-check"></i> Installed</button>` :
                        `<button class="modal-install-btn" onclick="installModelFromInfo('${model.name}')"><i class="fas fa-download"></i> Install</button>`;
                    
                    html += `
                        <div class="small-model-card">
                            <h4>${model.name}</h4>
                            <p>${model.description}</p>
                            <div class="size"><i class="fas fa-weight-hanging"></i> ${model.size}</div>
                            ${buttonHtml}
                        </div>
                    `;
                }
                
                html += '</div>';
                smallModelsContent.innerHTML = html;
            } else {
                smallModelsContent.innerHTML = '<p>No small models available.</p>';
            }
            
            // Also update the troubleshooting modal if it's open
            updateTroubleshootingSmallModels(data.models);
            
        } catch (error) {
            smallModelsContent.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> 
                    Error loading small models: ${error.message}
                </div>
            `;
        }
    }
    
    function updateTroubleshootingSmallModels(models) {
        const smallModelsOptions = document.getElementById('small-models-options');
        if (!smallModelsOptions) return;
        
        if (models && models.length > 0) {
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">';
            
            for (const model of models) {
                if (!model.installed) {
                    html += `
                        <button class="modal-install-btn" onclick="trySpecificModel('${model.name}')">
                            <i class="fas fa-cube"></i> Try ${model.name} (${model.size})
                        </button>
                    `;
                }
            }
            
            html += '</div>';
            smallModelsOptions.innerHTML = html;
        } else {
            smallModelsOptions.innerHTML = `
                <button class="modal-install-btn" onclick="tryAlternativeModel()">
                    <i class="fas fa-cube"></i> Try Tiny Model Instead
                </button>
            `;
        }
    }
    
    async function checkDnsStatus() {
        const dnsCheckContent = document.getElementById('dns-check-content');
        if (!dnsCheckContent) return;
        
        dnsCheckContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Testing network connections...</p>';
        
        try {
            const response = await fetch('/api/check_dns');
            
            if (!response.ok) {
                throw new Error('Failed to check DNS status');
            }
            
            const data = await response.json();
            
            let html = '<div class="dns-check-section">';
            
            // Current DNS servers
            html += `<p><strong>Current DNS Servers:</strong> `;
            if (data.system_dns && data.system_dns.length > 0) {
                html += data.system_dns.join(', ');
            } else {
                html += 'Unknown';
            }
            html += `</p>`;
            
            // Host connectivity
            html += `<p><strong>Host Connectivity:</strong></p>`;
            
            for (const [host, result] of Object.entries(data.dns_checks)) {
                const isSuccess = result.resolved;
                const statusClass = isSuccess ? 'dns-success' : 'dns-error';
                const statusIcon = isSuccess ? 
                    '<i class="fas fa-check-circle"></i>' : 
                    '<i class="fas fa-times-circle"></i>';
                
                    html += `
                    <div class="dns-status ${statusClass}">
                        ${statusIcon} ${host}: ${isSuccess ? 'Connected' : 'Failed'} 
                        ${isSuccess ? `(${result.ip_address})` : `(${result.error})`}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Add recommendation if there are issues
            const hasErrors = Object.values(data.dns_checks).some(result => !result.resolved);
            if (hasErrors) {
                html += `
                    <div class="network-troubleshooting">
                        <h4><i class="fas fa-exclamation-triangle"></i> DNS Issues Detected</h4>
                        <p>Try changing your DNS settings to Google DNS:</p>
                        <ul>
                            <li>8.8.8.8 (Primary)</li>
                            <li>8.8.4.4 (Secondary)</li>
                        </ul>
                        <p>This may resolve connection issues to model hosting services.</p>
                    </div>
                `;
            }
            
            dnsCheckContent.innerHTML = html;
            
        } catch (error) {
            dnsCheckContent.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i> 
                    Error checking network status: ${error.message}
                </div>
            `;
        }
    }
    
    async function installModelFromInfo(modelName) {
        // This function will be provided in script.js
        console.log(`Installing model: ${modelName}`);
        // The implementation from previous code will handle this
        
        const contentDiv = document.getElementById('model-info-content');
        if (!contentDiv) return;
        
        // Find the model row
        const tableRows = contentDiv.querySelectorAll('tbody tr');
        let modelRow = null;
        
        for (const row of tableRows) {
            const modelNameCell = row.querySelector('td:first-child');
            if (modelNameCell && modelNameCell.textContent === modelName) {
                modelRow = row;
                break;
            }
        }
        
        if (!modelRow) return;
        
        // Update the status cell
        const statusCell = modelRow.querySelector('td:nth-child(2)');
        const actionCell = modelRow.querySelector('td:nth-child(3)');
        
        if (statusCell && actionCell) {
            // Update status to installing
            statusCell.innerHTML = `
                <div class="model-status-container">
                    <span class="model-status model-installing"></span>
                    Installing...
                </div>
            `;
            
            // Update action button
            actionCell.innerHTML = `
                <button class="modal-install-btn" disabled>
                    <i class="fas fa-spinner fa-spin"></i> Installing...
                </button>
            `;
        }
        
        try {
            // Call the install API
            const response = await fetch('/api/install_model', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: modelName })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                const errorDetail = errorData.detail || '';
                
                // Check if it's a network/DNS issue
                if (errorDetail.includes('no such host') || 
                    errorDetail.includes('lookup') || 
                    errorDetail.includes('network error')) {
                    
                    // Show the network troubleshooting dialog
                    showNetworkTroubleshootingDialog(modelName);
                    
                    // Update status to error
                    if (statusCell) {
                        statusCell.innerHTML = `
                            <div class="model-status-container">
                                <span class="model-status model-not-installed"></span>
                                Network Error
                            </div>
                        `;
                    }
                    
                    if (actionCell) {
                        actionCell.innerHTML = `
                            <button class="modal-install-btn" onclick="showNetworkTroubleshootingDialog('${modelName}')">
                                <i class="fas fa-tools"></i> Troubleshoot
                            </button>
                        `;
                    }
                    
                    return;
                }
                
                throw new Error(errorData.detail || 'Installation failed');
            }
            
            // Installation started successfully
            if (statusCell) {
                statusCell.innerHTML = `
                    <div class="model-status-container">
                        <span class="model-status model-installing"></span>
                        Installing in background...
                    </div>
                `;
            }
            
            if (actionCell) {
                actionCell.innerHTML = `
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">
                        <i class="fas fa-cloud-download-alt"></i> Download started
                    </div>
                `;
            }
            
            // Set up polling to check installation status
            let checkCount = 0;
            const maxChecks = 6; // Will check for about 30 seconds
            
            const checkInstallation = async () => {
                checkCount++;
                
                try {
                    // Check if the model is now installed
                    const checkResponse = await fetch('/api/check_model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: modelName })
                    });
                    
                    if (checkResponse.ok) {
                        const checkData = await checkResponse.json();
                        
                        if (checkData.exists) {
                            // Model is installed
                            if (statusCell) {
                                statusCell.innerHTML = `
                                    <div class="model-status-container">
                                        <span class="model-status model-installed"></span>
                                        Installed
                                    </div>
                                `;
                            }
                            
                            if (actionCell) {
                                actionCell.innerHTML = `
                                    <button class="modal-install-btn" disabled>
                                        <i class="fas fa-check"></i> Installed
                                    </button>
                                `;
                            }
                            return; // End the polling
                        }
                    }
                    
                    // If we haven't reached max checks, continue polling
                    if (checkCount < maxChecks) {
                        setTimeout(checkInstallation, 5000); // Check every 5 seconds
                    } else {
                        // After max checks, tell user installation continues in background
                        if (statusCell) {
                            statusCell.innerHTML = `
                                <div class="model-status-container">
                                    <span class="model-status model-installing"></span>
                                    Installing (large model)
                                </div>
                            `;
                        }
                        
                        if (actionCell) {
                            actionCell.innerHTML = `
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    <i class="fas fa-info-circle"></i> Large model download continues in background
                                </div>
                                <button class="modal-install-btn" onclick="checkModelInstalled('${modelName}')" style="margin-top: 5px;">
                                    <i class="fas fa-sync-alt"></i> Check Status
                                </button>
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error checking installation:', error);
                    // If checking fails, just stop polling silently
                }
            };
            
            // Start polling
            setTimeout(checkInstallation, 5000);
            
        } catch (error) {
            console.error('Installation error:', error);
            
            // Check if it's a network error
            if (error.message && (
                error.message.includes('no such host') || 
                error.message.includes('lookup') || 
                error.message.includes('network error') ||
                error.message.includes('dns')
            )) {
                // Show the network troubleshooting dialog
                showNetworkTroubleshootingDialog(modelName);
                
                // Update status to error
                if (statusCell) {
                    statusCell.innerHTML = `
                        <div class="model-status-container">
                            <span class="model-status model-not-installed"></span>
                            Network Error
                        </div>
                    `;
                }
                
                if (actionCell) {
                    actionCell.innerHTML = `
                        <button class="modal-install-btn" onclick="showNetworkTroubleshootingDialog('${modelName}')">
                            <i class="fas fa-tools"></i> Troubleshoot
                        </button>
                    `;
                }
                
                return;
            }
            
            // Show generic error
            if (statusCell) {
                statusCell.innerHTML = `
                    <div class="model-status-container">
                        <span class="model-status model-not-installed"></span>
                        Installation Failed
                    </div>
                `;
            }
            
            if (actionCell) {
                actionCell.innerHTML = `
                    <div style="color: var(--error-color); font-size: 0.8rem;">
                        <i class="fas fa-exclamation-circle"></i> ${error.message}
                    </div>
                    <button class="modal-install-btn" onclick="installModelFromInfo('${modelName}')" style="margin-top: 5px;">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                `;
            }
        }
    }
    
    // Network troubleshooting dialog
    function showNetworkTroubleshootingDialog(modelName) {
        // Create a modal dialog for network troubleshooting if it doesn't exist
        let modal = document.getElementById('network-troubleshooting-modal');
        if (modal) {
            modal.style.display = 'block';
            return;
        }
        
        // Create the modal
        modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'network-troubleshooting-modal';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="document.getElementById('network-troubleshooting-modal').remove()">&times;</span>
                <h2><i class="fas fa-network-wired"></i> Network Troubleshooting</h2>
                
                <div class="troubleshooting-content">
                    <p>There appears to be a network issue preventing model download:</p>
                    <pre style="background: #1e1e1e; padding: 10px; overflow: auto; font-size: 0.8rem; color: #f44336; margin: 10px 0; border-radius: 4px; max-height: 100px;">
Error: lookup dd20bb891979d25aebc8bec07b2b3bbc.r2.cloudflarestorage.com: no such host</pre>
                    
                    <h3>Possible solutions:</h3>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 1: Fix DNS Settings</h4>
                        <p>Try updating your DNS settings to use Google's public DNS servers:</p>
                        <ul>
                            <li>Primary DNS: 8.8.8.8</li>
                            <li>Secondary DNS: 8.8.4.4</li>
                        </ul>
                        <p><a href="https://developers.google.com/speed/public-dns/docs/using" target="_blank" style="color: var(--accent-color);">How to change DNS settings</a></p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 2: Use Command Line</h4>
                        <p>Installing models through the command line sometimes works better:</p>
                        <pre style="background: #1e1e1e; padding: 10px; font-family: monospace; margin: 10px 0; border-radius: 4px;">ollama pull ${modelName}</pre>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 3: Use a Local Model</h4>
                        <p>You can also try using a smaller model that's easier to download:</p>
                        <div id="small-models-options">
                            <p><i class="fas fa-spinner fa-spin"></i> Loading small model options...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>Option 4: Check Firewall Settings</h4>
                        <p>Make sure your firewall allows Ollama to connect to the internet.</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn" style="background-color: var(--bg-tertiary); color: var(--text-primary);" onclick="document.getElementById('network-troubleshooting-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Load small models
        fetch('/api/list_small_models')
            .then(response => response.json())
            .then(data => {
                updateTroubleshootingSmallModels(data.models);
            })
            .catch(error => {
                console.error('Error loading small models for troubleshooting:', error);
                const smallModelsOptions = document.getElementById('small-models-options');
                if (smallModelsOptions) {
                    smallModelsOptions.innerHTML = `
                        <button class="modal-install-btn" onclick="tryAlternativeModel()">
                            <i class="fas fa-cube"></i> Try Tiny Model
                        </button>
                    `;
                }
            });
    }
    
    // Function to try a specific small model
    async function trySpecificModel(modelName) {
        // Close the troubleshooting modal
        const modal = document.getElementById('network-troubleshooting-modal');
        if (modal) {
            modal.remove();
        }
        
        // Change the model dropdown to the specified model
        const modelDropdown = document.getElementById('model-dropdown');
        if (modelDropdown) {
            // Check if the option exists
            let modelOption = Array.from(modelDropdown.options).find(option => 
                option.value === modelName
            );
            
            // If not found, create a new option
            if (!modelOption) {
                modelOption = document.createElement('option');
                modelOption.value = modelName;
                modelOption.textContent = modelName;
                modelDropdown.appendChild(modelOption);
            }
            
            // Set the dropdown to the model
            modelDropdown.value = modelName;
            
            // Show notification
            const notification = document.createElement('div');
            notification.className = 'system-message';
            notification.innerHTML = `
                <i class="fas fa-info-circle"></i>
                Switched to smaller model: <strong>${modelName}</strong> for easier download.
            `;
            
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.appendChild(notification);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Try to connect to the model
            setTimeout(() => {
                if (typeof connectToModel === 'function') {
                    connectToModel();
                }
            }, 1000);
        }
    }
    
    // Function to try any small model
    function tryAlternativeModel() {
        // Get small models and pick the first one
        fetch('/api/list_small_models')
            .then(response => response.json())
            .then(data => {
                if (data.models && data.models.length > 0) {
                    // Find the first model that isn't installed
                    const smallModel = data.models.find(model => !model.installed) || data.models[0];
                    trySpecificModel(smallModel.name);
                } else {
                    // If no small models found, show a message
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        const notification = document.createElement('div');
                        notification.className = 'system-message';
                        notification.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            No smaller models available. Please try installing a model manually using the command line:
                            <pre style="background: #1e1e1e; padding: 8px; margin-top: 10px; border-radius: 4px;">ollama pull tinyllama</pre>
                        `;
                        
                        chatMessages.appendChild(notification);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            })
            .catch(error => {
                console.error('Error getting small models:', error);
            });
    }
    
    // Function to check if a model is installed
    async function checkModelInstalled(modelName) {
        const contentDiv = document.getElementById('model-info-content');
        if (!contentDiv) return;
        
        // Find the model row
        const tableRows = contentDiv.querySelectorAll('tbody tr');
        let modelRow = null;
        
        for (const row of tableRows) {
            const modelNameCell = row.querySelector('td:first-child');
            if (modelNameCell && modelNameCell.textContent === modelName) {
                modelRow = row;
                break;
            }
        }
        
        if (!modelRow) return;
        
        // Get the cells
        const statusCell = modelRow.querySelector('td:nth-child(2)');
        const actionCell = modelRow.querySelector('td:nth-child(3)');
        
        if (statusCell && actionCell) {
            // Show checking status
            statusCell.innerHTML = `
                <div class="model-status-container">
                    <span class="model-status model-installing"></span>
                    Checking...
                </div>
            `;
            
            actionCell.innerHTML = `
                <button class="modal-install-btn" disabled>
                    <i class="fas fa-spinner fa-spin"></i> Checking...
                </button>
            `;
            
            try {
                // Check if the model is installed
                const response = await fetch('/api/check_model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelName })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.exists) {
                        // Model is installed
                        statusCell.innerHTML = `
                            <div class="model-status-container">
                                <span class="model-status model-installed"></span>
                                Installed
                            </div>
                        `;
                        
                        actionCell.innerHTML = `
                            <button class="modal-install-btn" disabled>
                                <i class="fas fa-check"></i> Installed
                            </button>
                        `;
                    } else {
                        // Model is not installed
                        statusCell.innerHTML = `
                            <div class="model-status-container">
                                <span class="model-status model-not-installed"></span>
                                Not Installed
                            </div>
                        `;
                        
                        actionCell.innerHTML = `
                            <button class="modal-install-btn" onclick="installModelFromInfo('${modelName}')">
                                <i class="fas fa-download"></i> Install
                            </button>
                        `;
                    }
                } else {
                    throw new Error('Failed to check model status');
                }
            } catch (error) {
                console.error('Error checking model:', error);
                
                // Show error
                statusCell.innerHTML = `
                    <div class="model-status-container">
                        <span class="model-status model-not-installed"></span>
                        Status Unknown
                    </div>
                `;
                
                actionCell.innerHTML = `
                    <button class="modal-install-btn" onclick="checkModelInstalled('${modelName}')">
                        <i class="fas fa-redo"></i> Check Again
                    </button>
                `;
            }
        }
    }
    
    // Expose functions to global scope
    window.installModelFromInfo = installModelFromInfo;
    window.checkModelInstalled = checkModelInstalled;
    window.showNetworkTroubleshootingDialog = showNetworkTroubleshootingDialog;
    window.trySpecificModel = trySpecificModel;
    window.tryAlternativeModel = tryAlternativeModel;
    </script>
    
    <script src="/static/js/script.js"></script>
</body>
</html>